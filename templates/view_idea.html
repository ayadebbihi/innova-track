{% extends "base.html" %}
{% block content %}

<div class="glass-container ">

    <!-- HEADER -->
    <div class="glass-card-3d mb-4">
        <div class="header-top">
            <div>
                <h2 class="idea-title">{{ idea.title }}</h2>
                <div class="meta-text">
                    <span class="badge cat-badge">{{ idea.category }}</span>
                    <span class="separator">â€¢</span>
                    <span class="date-text">{{ idea_time }}</span>
                </div>
            </div>

            <div class="rating-summary">
                <div class="avg-stars">â­ {{ avg_stars }}/5</div>
                <div class="score-line">
                    Score: <strong>{{ score }}</strong>  
                    <span class="vote-green">ğŸ‘ {{ upvotes }}</span>
                    <span class="vote-red">ğŸ‘ {{ downvotes }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- DESCRIPTION -->
    <div class="glass-card-3d p-4 mb-4">
        <h4 class="section-title">Description</h4>
        <p class="desc-text">{{ idea.description }}</p>
    </div>

    <!-- RATING & VOTES -->
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="glass-card-3d p-4">
                <h4 class="section-title">Your Rating </h4>
                <p class="hint-text">Click to select your rating</p>

                <div class="stars-container">
                    {% for s in range(1,6) %}
                        <a href="{{ url_for('rate', idea_id=idea.id, stars=s) }}" class="star-link">
                            <span class="star {% if user_stars >= s %}filled{% endif %}">â˜…</span>
                        </a>
                    {% endfor %}
                    <span class="rated-info">You rated: <strong>{{ user_stars }}</strong></span>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="glass-card-3d p-4 ">
                <h4 class="section-title">Your Voting </h4>
                <a href="{{ url_for('vote', idea_id=idea.id, action='up') }}" class="vote-btn upvote text-center">ğŸ‘ Upvote</a>

                <div class="score-display text-center">{{ score }}</div>

                <a href="{{ url_for('vote', idea_id=idea.id, action='down') }}" class="vote-btn downvote text-center">ğŸ‘ Downvote</a>
            </div>
        </div>
    </div>

    <!-- COMMENTS -->
    <div class="glass-card-3d p-4 mb-4">
        <h4 class="section-title">ğŸ’¬ Feedback & Comments ({{ comments|length }})</h4>
        
        <!-- ADD COMMENT -->
        <form action="{{ url_for('add_comment', idea_id=idea.id) }}" method="POST" class="mb-3">
            <textarea name="content" class="form-control glass-input" rows="3" placeholder="Write a comment..." required></textarea>
            <button class="btn btn-primary mt-2">Submit Comment</button>
        </form>

        <!-- COMMENTS LIST -->
        {% set parents = comments | selectattr('parent_id', '==', None) | list %}
        {% for c in parents %}
            <div class="comment-box glass-inner mb-3">

                <div class="comment-header">
                    <strong>{{ c.username }}</strong>
                    <span class="time">{{ c.timestamp_fmt }}</span>
                </div>

                <p class="comment-text">{{ c.content }}</p>

                <div class="comment-actions d-flex align-items-center gap-3 mt-2 mb-2">
    <!-- Like -->
    <a href="/comment_vote/{{ c.comment_id }}/up" class="comment-like">ğŸ‘</a>

    <!-- Score -->
    <span class="comment-score-badge">{{ c.score }}</span>

    <!-- Dislike -->
    <a href="/comment_vote/{{ c.comment_id }}/down" class="comment-dislike">ğŸ‘</a>

    <!-- Reply -->
    <button class="btn btn-sm btn-outline-secondary"
            type="button"
            onclick="toggleReply({{ c.comment_id }})">
        Reply
    </button>

    <!-- Delete -->
    {% if session.get("user_id") == c.user_id or session.get("role") == "admin" %}
    <form action="{{ url_for('delete_comment', comment_id=c.comment_id) }}"
          method="POST" style="display:inline;">
        <button class="btn btn-sm btn-danger ">Delete</button>
    </form>
    {% endif %}

</div>


                <!-- Reply box -->
                <form id="replyForm{{ c.comment_id }}" action="{{ url_for('add_comment', idea_id=idea.id) }}"
                      method="POST" class="reply-form glass-inner-small">
                    <input type="hidden" name="parent_id" value="{{ c.comment_id }}">
                    <textarea name="content" rows="2" class="form-control glass-input" placeholder="Write a reply..." required></textarea>
                    <button class="btn btn-primary btn-sm mt-2">Submit Reply</button>
                </form>

                <!-- CHILD COMMENTS -->
                {% for child in comments if child.parent_id == c.comment_id %}
                    <div class="reply-box glass-inner ms-4 mt-3">

                        <div class="comment-header">
                            <strong>{{ child.username }}</strong>
                            <span class="time">{{ child.timestamp_fmt }}</span>
                        </div>

                        <p class="comment-text">{{ child.content }}</p>

                        {% if session.get('user_id') == child.user_id or session.get('role') == 'admin' %}
                        <form action="{{ url_for('delete_comment', comment_id=child.comment_id) }}" method="POST">
                            <button class="delete-btn-small">Delete</button>
                        </form>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}

    </div>
<div class="d-flex gap-2 mb-3">

    {% if session.get('user_id') == idea.submitter_id or session.get('role') == 'admin' %}
        <a href="{{ url_for('edit_idea', idea_id=idea.id) }}"
   class="btn btn-warning me-2">âœ Edit Idea</a>


        <a href="{{ url_for('delete_idea', idea_id=idea.id) }}"
   class="btn btn-outline-danger"
   style="font-weight:600;"
   onclick="return confirm('âš ï¸ Are you absolutely sure you want to delete this idea?')">
   <i class="bi bi-trash-fill"></i> Delete Idea
</a>


    {% endif %}

</div>

    <a href="{{ url_for('ideas') }}" class="btn btn-secondary back-btn">â† Back to Ideas</a>
</div>


<style>
/* ---------------- GLOBAL GLASS CONTAINER ---------------- */
.comment .btn-sm {
    margin-left: 8px;
}

.comment-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.glass-container {
    max-width: 900px;
    margin: auto;
}
/* Ù…Ø±Ø¨Ø¹ Ø³ÙƒÙˆØ± Ø§Ù„ÙƒÙˆÙ…Ù†Øª */
.comment-score-badge {
    background: #ffcc00;
    color: #000;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: bold;
    display: inline-block;
}
/* === Improve comment score visibility in dark mode === */
.dark-mode .comment-score {
    color: #ffd84d !important;   /* Ø£ØµÙØ± Ù‚ÙˆÙŠ */
    font-weight: bold;
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.9));
}

/* ÙÙŠ Ø§Ù„Ø¯Ø§Ø±Ùƒ Ù…ÙˆØ¯ */
.dark-mode .comment-score-badge {
    background: #dece8b !important; /* Ø£ØµÙØ± Ø£Ù‚ÙˆÙ‰ ÙˆØ£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­ */
    color: #222 !important;          /* ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ø¶Ø­ Ø¬Ø¯Ø§Ù‹ */
    box-shadow: 0 0 6px rgba(255, 215, 0, 0.6); /* Ù„Ù…Ø¹Ø§Ù† Ø®ÙÙŠÙ Ø¬Ù…ÙŠÙ„ */
}

/* ---------------- 3D GLASS CARD ---------------- */
.glass-card-3d {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 18px;
    box-shadow:
        0 8px 20px rgba(0,0,0,0.25),
        0 0 40px rgba(255,255,255,0.10) inset;
    padding: 22px;
    transition: transform 0.18s ease;
}
.glass-card-3d:hover {
    transform: translateY(-4px) scale(1.01);
}

/* ---------------- HEADERS ---------------- */
.idea-title {
    font-size: 30px;
    font-weight: 700;
}

.meta-text {
    color: #cfcfcf;
    font-size: 13px;
}
.cat-badge {
    background: #4a6cff;
    padding: 5px 10px;
    border-radius: 6px;
}

/* ---------------- STARS ---------------- */
.star {
    font-size: 32px;
    color: #bbb;
    transition: 0.15s;
}
.star.filled {
    color: #ffdd55;
    transform: scale(1.15);
}
.star:hover {
    color: #ffe88c;
    transform: scale(1.25);
}

/* ---------------- VOTE BUTTONS ---------------- */
.vote-btn {
    display: block;
    padding: 12px;
    font-size: 20px;
    border-radius: 12px;
    transition: 0.2s;
}
.upvote { background: rgba(0,200,40,0.2); }
.downvote { background: rgba(200,0,40,0.2); }
.upvote:hover { background: rgba(0,255,60,0.4); }
.downvote:hover { background: rgba(255,0,60,0.4); }

.score-display {
    font-size: 40px;
    font-weight: 700;
    margin: 15px 0;
}

/* ---------------- COMMENTS ---------------- */
.comment-box, .reply-box {
    padding: 15px;
    border-radius: 12px;
}
.glass-inner {
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.18);
}
.glass-inner-small {
    padding: 10px;
    margin-top: 10px;
    display: none;
}

.comment-header {
    display: flex;
    justify-content: space-between;
}
.time { color: #bbb; font-size: 12px; }
.comment-text { margin-top: 10px; font-size: 15px; }

.reply-btn {
    background: transparent;
    border: 1px solid #aaa;
    padding: 3px 8px;
    border-radius: 6px;
    color: #ccc;
    transition: 0.2s;
}
.reply-btn:hover { border-color: white; color: white; }

.delete-btn, .delete-btn-small {
    border: none;
    background: rgba(255,0,0,0.2);
    padding: 4px 8px;
    border-radius: 6px;
    color: #ffdddd;
}
.delete-btn:hover { background: rgba(255,0,0,0.4); }

/* ---------------- INPUT ---------------- */
.glass-input {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.25);
    color: white;
}
.card {
    border-radius: 16px;
    backdrop-filter: blur(12px);
    background: rgba(255, 255, 255, 0.20);
    border: 1px solid rgba(255,255,255,0.35);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.dark-mode .card {
    background: rgba(20,20,20,0.35);
    border: 1px solid rgba(120,120,120,0.25);
}
.comment {
    background: rgba(255,255,255,0.25);
    border-radius: 12px;
}

.dark-mode .comment {
    background: rgba(40,40,40,0.35);
}
.card {
    transition: transform 0.15s ease;
}

.card:active {
    transform: scale(0.98);
}

/* ---------------- DISABLE FADE ANIMATION ---------------- */

</style>

<script>
function toggleReply(id){
    let el = document.getElementById("replyForm" + id);
    if (!el) return;
    el.style.display = el.style.display === "block" ? "none" : "block";
}
</script>
<style>
.fade-in {
    animation: none !important;
    transition: none !important;
}
</style>
{% endblock %}
